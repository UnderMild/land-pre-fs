<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Land Pre‑FS — Quick Feasibility Mockup (v6)</title>
<style>
  :root{
    --bg:#0b0d10;--card:#13171c;--ink:#e7ecf3;--muted:#9fb0c6;
    --lime:#a3ff3f; /* highlight lime */
    --teal:#56c2ff; /* highlight teal */
    --bad:#ff6b6b;--ok:#ffd166;--good:#06d6a0
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d10, #0f141a);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{font-size:1.25rem;margin:0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid #1e242c;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card h2{margin:0 0 8px 0;font-size:1rem}
  .row{display:grid;grid-template-columns:1fr 180px;gap:12px;align-items:center;margin:8px 0}
  .row > label{font-size:.95rem;color:var(--muted)}
  input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #28303a;background:#0b0f14;color:var(--ink);font-size:.95rem}
  .hint{font-size:.8rem;color:var(--muted);margin-top:2px}
  .twoway{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{border:1px solid #2a3340;border-radius:999px;padding:6px 10px;cursor:pointer;color:var(--muted)}
  .chip.active{background:linear-gradient(90deg,var(--teal),#b4e1ff);color:#0a0f12;border-color:transparent;font-weight:700}

  /* Output grid */
  .pairs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{background:#0d1217;border:1px solid #223041;border-radius:14px;padding:12px}
  .kpi .label{font-size:.8rem;color:var(--muted)}
  .kpi .value{font-size:1.15rem;font-weight:800;margin-top:4px}
  .kpi.hl-teal{border:2px solid var(--teal);box-shadow:0 0 0 4px rgba(86,194,255,.15)}
  .kpi.hl-lime{border:2px solid var(--lime);box-shadow:0 0 0 4px rgba(163,255,63,.15)}
  .kpi.full{grid-column:1 / span 2}

  .status{margin-top:10px;padding:10px 12px;border-radius:12px;font-weight:700}
  .status.good{background:rgba(6,214,160,.12);border:1px solid rgba(6,214,160,.4);color:#84ffd6}
  .status.ok{background:rgba(255,209,102,.12);border:1px solid rgba(255,209,102,.4);color:#ffe39a}
  .status.bad{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);color:#ffc2c2}

  /* Highlights in inputs */
  .tag{font-size:.7rem;border-radius:6px;padding:2px 6px;margin-left:8px;vertical-align:middle}
  .tag.teal{background:linear-gradient(90deg,var(--teal),#b4e1ff);color:#0a0f12}
  .tag.lime{background:linear-gradient(90deg,var(--lime),#d0ff9f);color:#0a0f12}
  .inp.teal input{border-color:#3a7fa6;box-shadow:0 0 0 3px rgba(86,194,255,.15)}
  .inp.lime input{border-color:#6edb2a;box-shadow:0 0 0 3px rgba(163,255,63,.15)}

  footer{opacity:.7;text-align:center;margin:20px 0;font-size:.8rem}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Land Pre‑FS <span style="opacity:.6">• Quick Feasibility Mockup</span></h1>
  </header>

  <div class="grid">
    <!-- INPUTS -->
    <section class="card">
      <h2>Inputs</h2>
      <div class="hint">Highlight: <span class="tag teal">Teal = ต้องใส่</span> • <span class="tag lime">Lime = Two‑way</span></div>

      <h3 style="margin:12px 0 6px;color:#bfe4ff;font-size:.9rem;">Land info</h3>
      <div class="row inp teal"><label>ไร่ <span class="tag teal">ต้องใส่</span></label><input id="rai" type="number" step="0.01" value="0"></div>
      <div class="row inp teal"><label>งาน <span class="tag teal">ต้องใส่</span></label><input id="ngan" type="number" step="1" value="0"></div>
      <div class="row inp teal"><label>ตารางวา <span class="tag teal">ต้องใส่</span></label><input id="sqw" type="number" step="1" value="0"></div>

      <h3 style="margin:12px 0 6px;color:#bfe4ff;font-size:.9rem;">Zoning / Density</h3>
      <div class="row inp teal"><label>FAR (base) <span class="tag teal">ต้องใส่</span></label><input id="far" type="number" step="0.1" value="0"></div>
      <div class="row inp teal"><label>Bonus FAR (%) <span class="tag teal">ต้องใส่</span></label><input id="bonus_far_pct" type="number" step="1" min="0" max="20" value="0"></div>
      <div class="row inp teal"><label>Efficiency (NSA/GFA) % <span class="tag teal">ต้องใส่</span></label><input id="eff" type="number" step="1" value="80"></div>

      <h3 style="margin:12px 0 6px;color:#bfe4ff;font-size:.9rem;">Core Economics</h3>
      <div class="row inp lime"><label>ราคาที่ดิน / ตร.วา <span class="tag lime">Two‑way</span></label><input id="land_price_per_sqw" type="number" step="1" value="0"></div>
      <div class="row inp teal"><label>ค่าธุรกรรมอื่นๆ (%) <span class="tag teal">ต้องใส่</span></label><input id="land_tax_pct" type="number" step="0.01" value="3"></div>
      <div class="row inp lime"><label>ต้นทุนก่อสร้าง / ตร.ม. (GFA) <span class="tag lime">Two‑way</span></label><input id="con_cost_per_gfa" type="number" step="100" value="24000"></div>
      <div class="row inp lime"><label>ราคาขาย / ตร.ม. (NSA) <span class="tag lime">Two‑way</span></label><input id="sell_price_per_nsa" type="number" step="100" value="65000"></div>
      <div class="row inp teal"><label>เป้ากำไรขั้นต้น (GM%) <span class="tag teal">ต้องใส่</span></label><input id="target_gm_pct" type="number" step="1" value="25"></div>
      <div class="row inp teal"><label>กำไรสุทธิ (NP%) <span class="tag teal">ต้องใส่</span></label><input id="np_pct" type="number" step="1" value="10"></div>

      <h3 style="margin:12px 0 6px;color:#bfe4ff;font-size:.9rem;">Units (Two‑way w.r.t NSA)</h3>
      <div class="row inp lime"><label>จำนวนยูนิต (units) <span class="tag lime">Two‑way</span></label><input id="unit_count" type="number" step="1" value="0"></div>
      <div class="row inp lime"><label>ขนาดยูนิตเฉลี่ย (ตร.ม./ยูนิต) <span class="tag lime">Two‑way</span></label><input id="avg_unit_size" type="number" step="1" value="0"></div>

      <h3 style="margin:12px 0 6px;color:#bfe4ff;font-size:.9rem;">Two‑Way Solver</h3>
      <div class="twoway">
        <div class="chip active" data-solve="sell">Solve → ราคาขาย / ตร.ม. (NSA)</div>
        <div class="chip" data-solve="land">Solve → ราคาที่ดิน / ตร.วา</div>
        <div class="chip" data-solve="con">Solve → ต้นทุนก่อสร้าง / ตร.ม. (GFA)</div>
      </div>
      <div class="hint">GM = (SP − CC<sub>NSA</sub> − Land/NSA) / SP • CC<sub>NSA</sub> = CC<sub>GFA</sub>/Eff</div>
    </section>

    <!-- OUTPUTS -->
    <section class="card">
      <h2>Decision Output</h2>

      <!-- Assumption Output -->
      <h3 style="margin:4px 0 8px;color:#bfe4ff;font-size:.9rem;">Assumption Output</h3>
      <div class="pairs">
        <div class="kpi"><div class="label">พื้นที่ดิน (sq.w.)</div><div id="out_sqw" class="value">0</div></div>
        <div class="kpi"><div class="label">พื้นที่ดิน (sq.m.)</div><div id="out_sqm" class="value">0</div></div>

        <div class="kpi"><div class="label">GFA (sq.m.)</div><div id="out_gfa" class="value">0</div></div>
        <div class="kpi"><div class="label">NSA (sq.m.)</div><div id="out_nsa" class="value">0</div></div>

        <div class="kpi hl-teal"><div class="label">Total Land cost (THB)</div><div id="out_land_total" class="value">-</div></div>
        <div class="kpi hl-teal"><div class="label">Land cost / sq.w.</div><div id="out_land_per_sqw" class="value">-</div></div>

        <div class="kpi hl-lime"><div class="label">Total Con Cost (THB)</div><div id="out_total_cc" class="value">-</div></div>
        <div class="kpi hl-lime"><div class="label">Con cost / sq.m. (GFA)</div><div id="out_cc_gfa" class="value">-</div></div>

        <div class="kpi"><div class="label">Total Dev Cost (THB)</div><div id="out_total_dev" class="value">-</div></div>
        <div class="kpi"><div class="label">COGs %</div><div id="out_cogs_pct" class="value">-</div></div>

        <div class="kpi"><div class="label">SG&amp;A % (auto = GM − NP)</div><div id="out_sga" class="value">-</div></div>
        <div class="kpi"><div class="label">NP %</div><div id="out_np_pct" class="value">-</div></div>

        <div class="kpi hl-lime full"><div class="label">Selling price / sq.m. (NSA)</div><div id="out_sp" class="value">-</div></div>
      </div>

      <!-- Project Output -->
      <h3 style="margin:12px 0 8px;color:#bfe4ff;font-size:.9rem;">Project Output</h3>
      <div class="pairs">
        <div class="kpi hl-lime"><div class="label">Project Value (ยอดขายรวม)</div><div id="out_pv" class="value">-</div></div>
        <div class="kpi hl-lime"><div class="label">Net Profit (THB)</div><div id="out_np" class="value">-</div></div>

        <div class="kpi"><div class="label">Total unit</div><div id="out_units" class="value">-</div></div>
        <div class="kpi"><div class="label">AVG. unit size (sq.m.)</div><div id="out_avg" class="value">-</div></div>
      </div>

      <div id="status" class="status ok" style="margin-top:12px;">ผลลัพธ์จะแสดงที่นี่</div>
      <div class="hint" id="gm_check" style="margin-top:6px;"></div>
      <div class="hint" id="sum_check" style="margin-top:2px;"></div>
    </section>
  </div>

  <footer>Land Pre‑FS • For workshop & discussion only</footer>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  const fmt = (n, digits=0) => {
    if(!isFinite(n)) return "-";
    return n.toLocaleString(undefined,{maximumFractionDigits:digits});
  };
  const chips = document.querySelectorAll('.chip');
  let solveMode = 'sell';

  // Track last-changed for units/avg size two-way
  let lastChanged = null;

  chips.forEach(ch=>{
    ch.addEventListener('click',()=>{
      chips.forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      solveMode = ch.dataset.solve; // 'sell' | 'land' | 'con'
      calc();
    })
  });

  const inputs = [
    'rai','ngan','sqw','far','bonus_far_pct','eff',
    'land_price_per_sqw','land_tax_pct',
    'con_cost_per_gfa','sell_price_per_nsa','target_gm_pct','np_pct',
    'unit_count','avg_unit_size'
  ];
  inputs.forEach(id => {
    $(id).addEventListener('input', (e)=>{
      if (id === 'unit_count' || id === 'avg_unit_size') lastChanged = id;
      calc();
    });
  });

  function safe(v){ const n = Number(v); return isFinite(n) ? n : 0; }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function calc(){
    // Read
    const rai  = safe($('rai').value);
    const ngan = safe($('ngan').value);
    const sqw  = safe($('sqw').value);
    const far  = safe($('far').value);
    const bfar_pct = clamp(safe($('bonus_far_pct').value), 0, 20); // 0-20%
    const eff  = safe($('eff').value)/100;

    let lp_sqw = safe($('land_price_per_sqw').value);
    const transPct  = safe($('land_tax_pct').value)/100;
    let cc_gfa = safe($('con_cost_per_gfa').value); // per GFA
    let sp     = safe($('sell_price_per_nsa').value); // per NSA
    const gmT  = safe($('target_gm_pct').value)/100; // user input
    let npT    = safe($('np_pct').value)/100;        // user input

    // Auto SG&A% = GM% - NP% (clip to [0,1])
    let sgaT = gmT - npT;
    if (sgaT < 0){ sgaT = 0; npT = gmT; $('np_pct').value = (npT*100).toFixed(1); }

    // Areas
    const land_sqw = rai*400 + ngan*100 + sqw;
    const land_sqm = land_sqw * 4; // 1 ตร.วา = 4 ตร.ม.

    // FAR with bonus as % of base
    const totalFAR = Math.max(0, far * (1 + bfar_pct/100));
    const gfa = land_sqm * totalFAR;
    const nsa = gfa * clamp(eff, 0, 1);

    // Land cost
    const land_total = land_sqw * lp_sqw * (1+transPct);
    const land_per_sqw = (land_sqw>0) ? land_total/land_sqw : NaN; // effectively lp_sqw*(1+transPct)

    // CC per NSA
    const cc_nsa = (eff>0) ? (cc_gfa / eff) : Infinity;

    // Land cost per NSA
    const land_per_nsa = nsa>0 ? land_total / nsa : Infinity;

    // Two‑way solve (pricing side)
    if (solveMode === 'sell'){
      const denom = 1 - gmT;
      sp = denom>0 ? (cc_nsa + land_per_nsa) / denom : Infinity;
      $('sell_price_per_nsa').value = isFinite(sp)? sp.toFixed(0): sp;
    } else if (solveMode === 'con'){
      const cc_nsa_target = sp*(1 - gmT) - land_per_nsa;
      cc_gfa = cc_nsa_target * eff;
      $('con_cost_per_gfa').value = isFinite(cc_gfa)? cc_gfa.toFixed(0): cc_gfa;
    } else if (solveMode === 'land'){
      const desired_land_per_nsa = sp*(1 - gmT) - cc_nsa;
      const allowed_land_total = desired_land_per_nsa * nsa;
      lp_sqw = land_sqw>0? allowed_land_total / (land_sqw * (1+transPct)) : 0;
      $('land_price_per_sqw').value = isFinite(lp_sqw)? lp_sqw.toFixed(0): lp_sqw;
    }

    // Re-read values after potential updates
    const cc_nsa_now = (eff>0) ? (safe($('con_cost_per_gfa').value) / eff) : Infinity;
    const sp_now = safe($('sell_price_per_nsa').value);

    // Totals
    const total_cc = isFinite(gfa) ? safe($('con_cost_per_gfa').value) * gfa : NaN; // GFA-based
    const total_dev = (isFinite(total_cc) && isFinite(land_total)) ? (total_cc + land_total) : NaN;

    // PV and percentages
    const pv = (isFinite(nsa) && isFinite(sp_now)) ? (nsa * sp_now) : NaN;
    const cogs_pct = (pv>0 && isFinite(total_dev)) ? (total_dev / pv * 100) : NaN;

    // Net Profit
    const net_profit = isFinite(pv) ? pv * npT : NaN;

    // Units two-way
    let units = Math.max(0, Math.floor(safe($('unit_count').value)));
    let avg   = safe($('avg_unit_size').value);
    if (nsa > 0){
      if (lastChanged === 'unit_count' && units > 0){
        avg = nsa / units;
        $('avg_unit_size').value = avg.toFixed(1);
      } else if (lastChanged === 'avg_unit_size' && avg > 0){
        units = Math.max(1, Math.floor(nsa / avg));
        $('unit_count').value = units;
      }
    }

    // Status by GM(calc)
    const gm_calc = sp_now>0 ? ((sp_now - cc_nsa_now - land_per_nsa)/sp_now) : NaN;
    const status = $('status');
    let cls='ok', msg='';
    if (!isFinite(gm_calc)){
      cls='bad'; msg='กรอกข้อมูลให้ครบ • NSA ต้องมากกว่า 0 เพื่อคำนวณ';
    } else if (gm_calc <= 0){
      cls='bad'; msg=`ไม่ผ่าน (GM ≤ 0%)`;
    } else {
      const gmPct = gm_calc*100;
      if (gmPct >= 28) { cls='good'; msg=`ผ่านดี • GM ≈ ${gmPct.toFixed(1)}%`; }
      else if (gmPct >= 20){ cls='ok'; msg=`พอได้ • GM ≈ ${gmPct.toFixed(1)}%`; }
      else { cls='bad'; msg=`ต่ำกว่าเป้า • GM ≈ ${gmPct.toFixed(1)}%`; }
    }
    status.className = 'status ' + cls;
    status.textContent = msg;

    // Checks
    const gm_target_pct = (gmT*100).toFixed(1);
    const sga_pct = (sgaT*100);
    const np_pct  = (npT*100);
    const gm_from_sganp = sga_pct + np_pct;
    $('gm_check').textContent = `GM (auto sum from SG&A% + NP%) = ${isFinite(gm_from_sganp)? gm_from_sganp.toFixed(1)+'%':'-'} • Target GM = ${gm_target_pct}%`;

    const sum_msg = isFinite(cogs_pct) ? `Check: COGs% (${cogs_pct.toFixed(1)}%) + GM(calc)% (${isFinite(gm_calc)? (gm_calc*100).toFixed(1): '-' }%) ≈ 100%` : '';
    $('sum_check').textContent = sum_msg;

    // Bind outputs
    $('out_sqw').textContent = fmt(land_sqw);
    $('out_sqm').textContent = fmt(land_sqm);
    $('out_gfa').textContent = fmt(gfa);
    $('out_nsa').textContent = fmt(nsa);

    $('out_land_total').textContent = isFinite(land_total)? fmt(land_total): '-';
    $('out_land_per_sqw').textContent = isFinite(land_per_sqw)? fmt(land_per_sqw): '-';

    $('out_total_cc').textContent = isFinite(total_cc) ? fmt(total_cc) : '-';
    $('out_cc_gfa').textContent = fmt(safe($('con_cost_per_gfa').value));

    $('out_total_dev').textContent = isFinite(total_dev)? fmt(total_dev) : '-';
    $('out_cogs_pct').textContent = isFinite(cogs_pct)? cogs_pct.toFixed(2)+'%':'-';

    $('out_sga').textContent = isFinite(sga_pct)? sga_pct.toFixed(1)+'%':'-';
    $('out_np_pct').textContent = isFinite(np_pct)? np_pct.toFixed(1)+'%':'-';
    $('out_sp').textContent = fmt(sp_now);

    $('out_pv').textContent = isFinite(pv) ? fmt(pv) : '-';
    $('out_np').textContent = isFinite(net_profit) ? fmt(net_profit) : '-';

    $('out_units').textContent = units>0 ? fmt(units) : '-';
    $('out_avg').textContent = avg>0 ? fmt(avg,1) : '-';
  }

  calc();
</script>
</body>
</html>
